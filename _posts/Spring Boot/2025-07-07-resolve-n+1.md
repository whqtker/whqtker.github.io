---
title : "[JPA] ì˜ˆì œë¥¼ í†µí•œ N+1 ë¬¸ì œ í•´ê²° ë°©ë²•"
date : 2025-07-07 15:50:00 +0900
categories : [Spring Boot]
tags : [java, spring boot, jpa, N+1, ìŠ¤í”„ë§ ë¶€íŠ¸, batch, fetch join, EntityGraph]
---

## ğŸ“Œ N+1 ë¬¸ì œë€?

í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¥¼ ê¸°ëŒ€í–ˆìœ¼ë‚˜Â **ì˜ë„ì¹˜ ì•Šê²Œ Nê°œì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒ**í•˜ëŠ” ë¬¸ì œë¥¼ ë§í•œë‹¤.

ì´ë¥¼ í•´ê²°í•˜ëŠ” ëŒ€í‘œì ì¸ ì„¸ ê°€ì§€ ë°©ë²•ì´ ìˆëŠ”ë°, `Fetch Join`, `@EntityGraph` , `Batch Size` ì´ë‹¤. ê° ë°©ë²•ìœ¼ë¡œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì„ ì˜ˆì œë¥¼ í†µí•´ ì‚´í´ë³´ì.

![np1.drawio.png](assets/img/jpa/4.png)

```java
public class Post {

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false)
    private String content;

    @OneToMany(mappedBy = "post", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Comment> comments = new ArrayList<>();

    public Post (String title, String content) {
        this.title = title;
        this.content = content;
    }
}
```

```java
public class Comment {

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(nullable = false)
    private String content;

    @ManyToOne(fetch = FetchType.LAZY)
    private Post post;

    public Comment (Post post, String content) {
        this.post = post;
        this.content = content;
    }
}
```

ì—”í‹°í‹° ê°„ ì—°ê´€ê´€ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
@Transactional(readOnly = true)
public PostListResponse getAllPosts() {
    List<Post> posts = postRepository.findAll();

    List<PostResponse> postResponses = posts.stream()
            .map(PostResponse::from)
            .toList();

    return PostListResponse.from(postResponses);
}
```

ì „ì²´ ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì„ ì¡°íšŒí•˜ëŠ” `getAllPosts` ë©”ì„œë“œì´ë‹¤.

ë§Œì•½ 10ê°œì˜ ê²Œì‹œê¸€ì„ ìƒì„±í•˜ê³  ê° ê²Œì‹œê¸€ë§ˆë‹¤ 3ê°œì˜ ëŒ“ê¸€ì„ ìƒì„±í–ˆë‹¤ê³  í•˜ì. ê³¼ì—° ëª‡ ê°œì˜ ì¿¼ë¦¬ê°€ ë°œìƒí• ê¹Œ? ê°„ë‹¨í•˜ê²Œ ë¡œê·¸ë¥¼ ì°ì–´ì„œ í™•ì¸í•´ë³´ì.

```java
@Transactional(readOnly = true)
public PostListResponse getAllPosts() {
    SessionFactory sessionFactory = entityManagerFactory.unwrap(SessionFactory.class);
    Statistics statistics = sessionFactory.getStatistics();
    statistics.clear();

    List<Post> posts = postRepository.findAll();

    log.info("===== ëŒ“ê¸€ ì ‘ê·¼ ì „ ì¿¼ë¦¬ ìˆ˜: {} =====", statistics.getPrepareStatementCount());

    List<PostResponse> postResponses = posts.stream()
            .map(PostResponse::from)
            .toList();

    log.info("===== ëŒ“ê¸€ ì ‘ê·¼ í›„ ì¿¼ë¦¬ ìˆ˜: {} =====", statistics.getPrepareStatementCount());

    return PostListResponse.from(postResponses);
}
```

```
2025-07-06T20:15:44.129+09:00  INFO 15240 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ ì „ ì¿¼ë¦¬ ìˆ˜: 1 =====

2025-07-06T20:15:44.151+09:00  INFO 15240 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ í›„ ì¿¼ë¦¬ ìˆ˜: 11 =====
```

ë¨¼ì € `findAll` ë©”ì„œë“œë¥¼ í†µí•´ ëª¨ë“  ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ 1ê°œê°€ ë°œìƒí•œë‹¤. ì´ ì‹œì ì—” ëŒ“ê¸€ì„ í•¨ê»˜ ì¡°íšŒí•˜ì§€ ì•ŠëŠ”ë°, `@OneToMany` ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ì¦‰, ì‹¤ì œë¡œ ëŒ“ê¸€ì„ ì¡°íšŒí•  ë•Œ ì¶”ê°€ì ì¸ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.

```java
public record PostResponse(
        Long id,
        String title,
        String content,
        List<CommentResponse> comments
) {
    public static PostResponse from(Post post) {
        List<CommentResponse> commentResponses = post.getComments().stream()
                .map(CommentResponse::from)
                .toList();

        return new PostResponse(
                post.getId(),
                post.getTitle(),
                post.getContent(),
                commentResponses
        );
    }
}
```

ê° ê²Œì‹œê¸€ì— ëŒ€í•´ ëŒ“ê¸€ì„ ì¡°íšŒí•˜ëŠ” ì¶”ê°€ì ì¸ ì¿¼ë¦¬ 10ê°œëŠ” `from` ë©”ì„œë“œì—ì„œ ì‹¤ì œë¡œ ëŒ“ê¸€ ì—”í‹°í‹°ì— ì ‘ê·¼í•  ë•Œ ë°œìƒí•œë‹¤. 

ë‹¨ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¥¼ ê¸°ëŒ€í–ˆìœ¼ë‚˜, ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ ì¶”ê°€ë¡œ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì˜€ê³ , ì´ëŠ” ì„±ëŠ¥ ì €í•˜ë¡œ ì´ì–´ì§„ë‹¤. ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ì.

## ğŸ“Œ Fetch Join

```java
@Query("SELECT DISTINCT p FROM Post p LEFT JOIN FETCH p.comments")
List<Post> findAllWithComments();
```

```
2025-07-06T21:11:39.496+09:00  INFO 27076 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ ì „ ì¿¼ë¦¬ ìˆ˜: 0 =====
2025-07-06T21:11:39.599+09:00 DEBUG 27076 --- [nio-8080-exec-1] org.hibernate.SQL                        : 
    select
        distinct p1_0.id,
        c1_0.post_id,
        c1_0.id,
        c1_0.content,
        p1_0.content,
        p1_0.title 
    from
        post p1_0 
    left join
        comment c1_0 
            on p1_0.id=c1_0.post_id
2025-07-06T21:11:39.662+09:00  INFO 27076 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ í›„ ì¿¼ë¦¬ ìˆ˜: 1 =====
```

ì¼ë°˜ì ì¸ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ JPQLì—ì„œ ì¡°íšŒ ì£¼ì²´ê°€ ë˜ëŠ” ì—”í‹°í‹°ë§Œ ë¶ˆëŸ¬ì˜¤ì§€ë§Œ, `Fetch Join` ì„ ì‚¬ìš©í•˜ë©´ ì¡°ì¸ì´ ê±¸ë¦° ì—°ê´€ ì—”í‹°í‹°ë„ í•¨ê»˜ ë¶ˆëŸ¬ì˜¨ë‹¤. ë”°ë¼ì„œ ë‹¨ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë§Œìœ¼ë¡œ ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì„ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

## ğŸ“Œ @EntityGraph

```java
@Override
@EntityGraph(attributePaths = {"comments"})
List<Post> findAll();
```

`@EntityGraph` ë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆì§€ë§Œ, `findAll` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•˜ë„ë¡ êµ¬í˜„í•˜ì˜€ë‹¤. `attributePaths` ì˜ ì˜ë¯¸ëŠ” `Post` ì—”í‹°í‹°ì™€ ì—°ê´€ëœ `comments` í•„ë“œë¥¼ ê·¸ë˜í”„ í˜•íƒœë¡œ íƒìƒ‰í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

ë‚´ë¶€ì ìœ¼ë¡œ Fetch Joinê³¼ ìœ ì‚¬í•œ `LEFT OUTER JOIN` ì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

## ğŸ“Œ Batch Size

```java
@BatchSize(size = 100)
@OneToMany(mappedBy = "post", cascade = CascadeType.ALL, orphanRemoval = true)
private List<Comment> comments = new ArrayList<>();
```

```
2025-07-06T21:33:15.125+09:00  INFO 12888 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ ì „ ì¿¼ë¦¬ ìˆ˜: 1 =====
2025-07-06T21:33:15.217+09:00 DEBUG 12888 --- [nio-8080-exec-1] org.hibernate.SQL                        : 
    select
        p1_0.id,
        p1_0.content,
        p1_0.title 
    from
        post p1_0
2025-07-06T21:33:15.247+09:00 DEBUG 12888 --- [nio-8080-exec-1] org.hibernate.SQL                        : 
    select
        c1_0.post_id,
        c1_0.id,
        c1_0.content 
    from
        comment c1_0 
    where
        c1_0.post_id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
2025-07-06T21:33:15.253+09:00  INFO 12888 --- [nio-8080-exec-1] o.l.p.post.service.PostService           : ===== ëŒ“ê¸€ ì ‘ê·¼ í›„ ì¿¼ë¦¬ ìˆ˜: 2 =====
```

`@BatchSize` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ `IN` ì ˆì„ ì‚¬ìš©í•˜ì—¬ ì„¤ì •ëœ sizeë§Œí¼ì˜ ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•œë‹¤. 

ì´ì „ í•´ê²° ë°©ë²•ê³¼ ë‹¤ë¥¸ ì ì€, ëŒ“ê¸€ë§Œ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ì¡´ì¬í•œë‹¤ëŠ” ê²ƒì´ë‹¤. ì¦‰, ë‹¨ í•œ ë²ˆìœ„ ì¿¼ë¦¬ë¡œ ìµœì í™”ë˜ì§€ ì•ŠëŠ”ë‹¤.

ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ Nê°œì˜ ì¿¼ë¦¬ê°€ ì•„ë‹ˆë¼ N/size ê°œì˜ ì¿¼ë¦¬ë§Œ ë°œìƒí•œë‹¤. ì¦‰, sizeì— ë”°ë¼ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ì˜ ìˆ˜ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.

## ğŸ“Œ ê¹ƒí—ˆë¸Œ

[https://github.com/whqtker/practice-n-plus-1](https://github.com/whqtker/practice-n-plus-1)