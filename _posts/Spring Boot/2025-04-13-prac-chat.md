---
title : "ì±„íŒ… êµ¬í˜„ ì˜ˆì œ w/ Polling, Long Polling, SSE, WebSocket"
date : 2025-04-13 18:40:00 +0900
categories : [Spring Boot]
tags : [java, spring boot, polling, long polling, sse, websocket, network, practice]
---

## ğŸ“Œ ê°œìš”

Polling, Long Polling, SSE, WebSocketë¥¼ ì‚¬ìš©í•˜ì—¬ ì±„íŒ… ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì. ëª…ì‹œëœ ê¸°ìˆ ë“¤ì˜ êµ¬í˜„ ë°©ì‹ì— ì´ˆì ì„ ë§ì¶”ì–´ ì‘ì„±ë˜ì—ˆë‹¤.

`Polling`ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ê³ , ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë¦¬í„´í•˜ëŠ” ë°©ë²•ì´ë‹¤.

`Long polling`ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚¸ í›„ ì„œë²„ê°€ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ìš”ì²­ì„ ìœ ì§€í•˜ëŠ” ë°©ì‹ì´ë‹¤.

`SSE(Server-Sent Events)`ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ë©´ ì„œë²„ê°€ ì§€ì†ì ì¸ ì—°ê²°ì„ ìœ ì§€í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•ì´ë‹¤.

`WebSocket`ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ì§€ì†ì ì¸ ì—°ê²°ì„ í†µí•œ ì–‘ë°©í–¥ ë°ì´í„° ì „ì†¡ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ë°©ë²•ì´ë‹¤.

## ğŸ“Œ ê°œë°œ í™˜ê²½

JDK: 21

Java: 21

Spring Boot: 3.4.4

## ğŸ“Œ ìˆ˜ë™

### Server

```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/chat")
public class ChatController {
    private final ChatService chatService;

    @PostMapping("/write")
    @ResponseBody
    public ResponseEntity<ChatDto.WriteMessageResponse> writeMessage(@RequestBody ChatDto.WriteMessageRequest writeMessageRequest) {
        Chat chat = chatService.writeMessage(writeMessageRequest.getName(), writeMessageRequest.getContent());

        return ResponseEntity.ok(
                ChatDto.WriteMessageResponse.builder()
                        .chat(chat)
                        .build()
        );
    }

    // ...

    @GetMapping("/messages")
    @ResponseBody
    public ResponseEntity<ChatDto.MessagesResponse> messages(Long fromId) {
        return ResponseEntity.ok(
                ChatDto.MessagesResponse.builder()
                        .chats(chatService.getMessages(fromId))
                        .totalCount(chatService.getTotalCount())
                        .build()
        );
    }

    // ...
}
```

`/chat/write` ì— ì ‘ê·¼í•˜ë©´ ì‚¬ìš©ìì˜ ì´ë¦„ê³¼ ë©”ì„¸ì§€ë¥¼ DBì— ì €ì¥í•œë‹¤.

`/chat/messages?fromId={id}` ì— ì ‘ê·¼í•˜ë©´ `id` ì´í›„ì˜ ë©”ì„¸ì§€ë“¤ì„ ê°€ì ¸ì˜¨ë‹¤.

### Client

```html
<div class="chat">
    <form
            class="chat__write-message"
            onsubmit="Chat__writeMessage(this); return false;"
    >
        <input type="text" placeholder="ì‘ì„±ì" name="name" />
        <input type="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="content" />
        <input type="submit" value="ì‘ì„±" />
    </form>
    <div class="chat__message-box">
        <ul class="chat__message-ul"></ul>
    </div>
</div>
<button onclick="Chat__loadMore();">ìƒˆë¡œê³ ì¹¨</button>
<script>
    function fetchPost(url, data) {
        return fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
            },
            body: JSON.stringify(data),
        }).then((response) => response.json());
    }

    function fetchGet(url, data) {
        let query = Object.keys(data)
            .map((k) => encodeURIComponent(k) + "=" + encodeURIComponent(data[k]))
            .join("&");
        return fetch(url + "?" + query, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
            },
        }).then((response) => response.json());
    }

    // ë©”ì‹œì§€ ì‘ì„± ì²˜ë¦¬ í•¨ìˆ˜
    function Chat__writeMessage(form) {
        form.name.value = form.name.value.trim();
        if (form.name.value.length == 0) {
            alert("ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            form.name.focus();
            return;
        }

        // ë©”ì‹œì§€ ë‚´ìš© ìœ íš¨ì„± ê²€ì‚¬
        form.content.value = form.content.value.trim();
        if (form.content.value.length == 0) {
            form.content.focus();
            return;
        }

        // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
        fetchPost("/chat/write", {
            name: form.name.value,
            content: form.content.value,
        }).then(console.log); 

        form.content.value = "";
        form.content.focus();
    }

    // ì±„íŒ… ë©”ì„¸ì§€ë“¤ ì½ê¸°
    let Chat__lastLoadedId = 0;
    function Chat__loadMore() {
        fetchGet("/chat/messages", {
            fromId: Chat__lastLoadedId
        })
            .then(body => {
                Chat__drawMessages(body.chats);
            });
    }
    const Chat__elMessageUl = document.querySelector('.chat__message-ul');
    function Chat__drawMessages(messages) {
        console.log("messages", messages);
        if (messages.length > 0)
            Chat__lastLoadedId = messages[messages.length - 1].id;
        messages.forEach((message) => {
            Chat__elMessageUl
                .insertAdjacentHTML(
                    "afterBegin",
                    `<li>${message.name} : ${message.content}</li>`
                );
        });
    }
</script>
```

ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ë©´ `fetchPost()` ë¥¼ í†µí•´ ì„œë²„ë¡œ ì „ì†¡ëœë‹¤.

ì‚¬ìš©ìê°€ â€˜ìƒˆë¡œê³ ì¹¨â€™ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ `Chat__loadMore()` ì´ í˜¸ì¶œëœë‹¤. ì„œë²„ì—ê²Œ `Chat__lastLoadedId` ì´í›„ì˜ ë©”ì„¸ì§€ë“¤ì„ ìš”ì²­í•œë‹¤.

### ë™ì‘ ê³¼ì •

![refresh.png](assets/img/prac_chat/1.png)

## ğŸ“Œ Polling

### Server

Pollingì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ëŠ” ë°©ë²•ì´ë‹¤. ì„œë²„ëŠ” ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë³´ë‚´ì£¼ê¸°ë§Œ í•˜ë©´ ë˜ë¯€ë¡œ, ë”°ë¡œ íŠ¹ë³„í•œ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ì´ì „ ì„œë²„ ì½”ë“œì™€ ë™ì¼í•˜ë‹¤.

### Client

```html
<!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ì œê±°í•œë‹¤. -->
<script>
    // ...

    let Chat__lastLoadedId = 0;
    function Chat__loadMore() {
        fetchGet("/chat/messages", {
            fromId: Chat__lastLoadedId
        })
            .then(body => {
                Chat__drawMessages(body.chats);
            });
    }
    const Chat__elMessageUl = document.querySelector('.chat__message-ul');
    function Chat__drawMessages(messages) {
        console.log("messages", messages);
        if (messages.length > 0)
            Chat__lastLoadedId = messages[messages.length - 1].id;
        messages.forEach((message) => {
            Chat__elMessageUl
                .insertAdjacentHTML(
                    "afterBegin",
                    `<li>${message.name} : ${message.content}</li>`
                );
        });
        setTimeout(Chat__loadMore, 500); // 0.5ì´ˆë§ˆë‹¤ ìš”ì²­
    }
    Chat__loadMore(); // ì´ˆê¸° ë©”ì„¸ì§€ ë¡œë“œ
</script>
```

ì¼ì • ì£¼ê¸°(0.5ì´ˆ)ë§ˆë‹¤ `Chat__loadMore()` ì„ í˜¸ì¶œí•œë‹¤.

### ë™ì‘ ê³¼ì •

![polling.png](assets/img/prac_chat/2.png)

## ğŸ“Œ Long Polling

### Server

```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/chat")
public class ChatController {
    private final ChatService chatService;

    @PostMapping("/write")
    @ResponseBody
    public ResponseEntity<ChatDto.WriteMessageResponse> writeMessage(@RequestBody ChatDto.WriteMessageRequest writeMessageRequest) {
        Chat chat = chatService.writeMessage(writeMessageRequest.getName(), writeMessageRequest.getContent());

        return ResponseEntity.ok(
                ChatDto.WriteMessageResponse.builder()
                        .chat(chat)
                        .build()
        );
    }

    // ...

    @GetMapping("/messages/long-polling")
    @ResponseBody
    public ResponseEntity<ChatDto.MessagesResponse> longPollingMessages(Long fromId) throws InterruptedException {
        List<Chat> chats;

        while (true) {
            chats = chatService.getMessages(fromId);

            if (!chats.isEmpty()) {
                return ResponseEntity.ok(
                        ChatDto.MessagesResponse.builder()
                                .chats(chats)
                                .totalCount(chatService.getTotalCount())
                                .build()
                );
            }

            Thread.sleep(500);
        }
    }

    // ...
}
```

í´ë¼ì´ì–¸íŠ¸ê°€ ë©”ì„¸ì§€ ì¡°íšŒ ìš”ì²­ì„ ë³´ë‚´ë©´ ì„œë²„ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤. 0.5ì´ˆë§ˆë‹¤ ìƒˆë¡œìš´ ë©”ì„¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.

### Client

```html
<!-- ... -->

<script>
    // ...

    // Long Polling - GET
    function fetchGetLongPolling(url, data) {
        let query = Object.keys(data)
            .map((k) => encodeURIComponent(k) + "=" + encodeURIComponent(data[k]))
            .join("&");
        
        return fetch(url + "?" + query, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
            },
            // Long Polling íƒ€ì„ì•„ì›ƒ ì„¤ì •
            signal: AbortSignal.timeout(30000) // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
        }).then((response) => response.json());
    }

    // ...

    // Long Pollingì„ ì‚¬ìš©í•œ ë©”ì‹œì§€ ë¡œë“œ í•¨ìˆ˜
    function Chat__loadMore() {
        fetchGetLongPolling("/chat/messages/long-polling", {
            fromId: Chat__lastLoadedId
        })
        .then(body => {
            if (body.chats && body.chats.length > 0) {
                Chat__drawMessages(body.chats);
            }
        })
        .catch(error => {
            if (error.name === 'TimeoutError') {
                console.log("Long polling timeout");
            } else {
                console.error("Error in long polling:", error);
            }
        })
        .finally(() => {
            // ì‘ë‹µì„ ë°›ì€ í›„ ì¦‰ì‹œ ë‹¤ìŒ ìš”ì²­ ì‹œì‘
            Chat__loadMore();
        });
    }

    // ...

    // ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘
    Chat__loadMore();
</script>
```

ë§Œì•½ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ì‘ë‹µì„ ë°›ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì¦‰ì‹œ ìƒˆë¡œìš´ ìš”ì²­ì„ ì„œë²„ì—ê²Œ ë³´ë‚¸ë‹¤. í´ë¼ì´ì–¸íŠ¸ ì—­ì‹œ 30ì´ˆ íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•˜ì˜€ê³ , íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•˜ë©´ ìƒˆë¡œìš´ ìš”ì²­ì„ ì„œë²„ì— ì „ì†¡í•œë‹¤.

### ë™ì‘ ê³¼ì •

![long-polling.png](assets/img/prac_chat/3.png)

## ğŸ“Œ SSE

### Server

```java
@Component
@Slf4j
public class SseEmitters {
    private final List<SseEmitter> emitters = new CopyOnWriteArrayList<>();

    public SseEmitter add(SseEmitter emitter) {
        this.emitters.add(emitter);

        emitter.onCompletion(() -> {
            this.emitters.remove(emitter);
        });

        emitter.onTimeout(() -> {
            emitter.complete();
        });

        return emitter;
    }

    public void noti(String eventName) {
        noti(eventName, Ut.mapOf());
    }

    public void noti(String eventName, Map<String, Object> data) {
        emitters.forEach(emitter -> {
            try {
                emitter.send(
                        SseEmitter.event()
                                .name(eventName)    
                                .data(data)        
                );
            } catch (ClientAbortException e) {
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        });
    }
}
```

`add()` ëŠ” ìƒˆë¡œìš´ SSE ì—°ê²°ì„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê³ , ì—°ê²° ì¢…ë£Œ ë˜ëŠ” íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•œ ê²½ìš°ì— ëŒ€í•œ ì²˜ë¦¬ë¥¼ ë‹´ê³  ìˆë‹¤.

`noti()` ëŠ” ì„œë²„ì— ì—°ê²°ëœ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì— ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

```java
@Controller
@RequestMapping("/sse")
@RequiredArgsConstructor
public class SseController {
    private final SseEmitters sseEmitters;

    // /sse/connectë¡œ GET ìš”ì²­ì´ ì˜¤ë©´ SSE ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±
    @GetMapping(value = "/connect", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public ResponseEntity<SseEmitter> connect() {
        SseEmitter emitter = new SseEmitter();

        sseEmitters.add(emitter);

        try {
            emitter.send(SseEmitter.event()
                    .name("connect")    
                    .data("connected!"));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        return ResponseEntity.ok(emitter);
    }
}
```

`/sse/connect` ì— ì ‘ê·¼í•˜ëŠ” ê²½ìš° ë™ì‘ì„ ì‚´í´ë³´ì. ë¨¼ì € ìƒˆë¡œìš´ SSE emitterë¥¼ ìƒì„±í•˜ê³ , ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ì—¬ ê´€ë¦¬í•œë‹¤. ì´ˆê¸° ì—°ê²° ìˆ˜ë¦½ ì‹œ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì—°ê²° ì„±ê³µ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•œë‹¤.

```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/chat")
public class ChatController {
    private final ChatService chatService;

    // ...

    @PostMapping("/write-sse")
    @ResponseBody
    public ResponseEntity<ChatDto.WriteMessageResponse> writeMessageSse(@RequestBody ChatDto.WriteMessageRequest writeMessageRequest) {
        Chat chat = chatService.writeMessageSse(writeMessageRequest.getName(), writeMessageRequest.getContent());

        return ResponseEntity.ok(
                ChatDto.WriteMessageResponse.builder()
                        .chat(chat)
                        .build()
        );
    }
    
    // ...

    @GetMapping("/messages")
    @ResponseBody
    public ResponseEntity<ChatDto.MessagesResponse> messages(Long fromId) {
        return ResponseEntity.ok(
                ChatDto.MessagesResponse.builder()
                        .chats(chatService.getMessages(fromId))
                        .totalCount(chatService.getTotalCount())
                        .build()
        );
    }

    // ...
}
```

```java
@Service
@RequiredArgsConstructor
public class ChatService {
    private final ChatRepository chatRepository;
    private final SseEmitters sseEmitters;
    
    // ...

    @Transactional
    public Chat writeMessageSse(String name, String content) {
        Chat chat = Chat.builder()
                .name(name)
                .content(content)
                .createDate(LocalDateTime.now())
                .build();

        sseEmitters.noti("chat__messageAdded");

        return chatRepository.save(chat);
    }

    // ...
}
```

`/write-sse` ì— ì ‘ê·¼í•˜ë©´ ì„œë¹„ìŠ¤ ë¡œì§ì—ì„œ `noti()` ë¥¼ í†µí•´ `chat__messageAdded` ì´ë²¤íŠ¸ë¥¼ ì—°ê²°ëœ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì— ë¸Œë¡œë“œìºìŠ¤íŠ¸í•œë‹¤.

### Client

```html
<!-- ... -->
<script>
    // ...

    // ë©”ì‹œì§€ ì‘ì„± ì²˜ë¦¬ í•¨ìˆ˜
    function Chat__writeMessage(form) {
        // ...

        fetchPost("/chat/write-sse", {
            name: form.name.value,
            content: form.content.value,
        }).then(console.log); 

        form.content.value = "";
        form.content.focus();
    }

    // ...

    Chat__loadMore();

    const sse = new EventSource("/sse/connect");

    sse.addEventListener('chat__messageAdded', e => {
        Chat__loadMore();
    });
</script>
```

`setTimeout()` ì„ ì œê±°í•˜ê³ , `EventSource` ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì„œë²„ì™€ ì—°ê²°ì„ ì‹œì‘í•œë‹¤.

### ë™ì‘ ê³¼ì •

![sse.png](assets/img/prac_chat/4.png)

## ğŸ“Œ WebSocket

### Server

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws").withSockJS();
    }
    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableSimpleBroker("/topic");
        registry.setApplicationDestinationPrefixes("/app");
    }
}
```

`registerStompEndpoints()` ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ìˆëŠ” WebSocket ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë“±ë¡í•œë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” `/ws` ì— ì ‘ê·¼í•˜ì—¬ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ìˆë‹¤. `SockJS` ëŠ” WebSocketì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œë„ ì—°ê²°ì„ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. WebSocket ëŒ€ì‹  Long Pollingê³¼ ê°™ì€ HTTP ê¸°ë°˜ Fallbackì„ ì‚¬ìš©í•œë‹¤.

`configureMessageBroker()` ëŠ” ë©”ì„¸ì§€ ë¸Œë¡œì»¤ë¥¼ êµ¬ì„±í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ë©”ì„¸ì§€ êµí™˜ì„ ì²˜ë¦¬í•œë‹¤. `enableSimpleBroker("/topic")` ì€ `/topic` ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ëŠ” `pub-sub` ëª¨ë¸ì„ í™œì„±í™”í•œë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ /topic ê²½ë¡œë¥¼ êµ¬ë…í•˜ë©´ í•´ë‹¹ ê²½ë¡œë¡œ ë°œí–‰ëœ ë©”ì„¸ì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤. `setApplicationDestinationPrefixes("/app")` ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²½ë¡œì˜ ì ‘ë‘ì‚¬ë¥¼ `/app` ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

`WebSocket` ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ì–‘ë±¡í–¥ í†µì‹ ì„ ì§€ì›í•˜ëŠ” í”„ë¡œí† ì½œì´ê³ , `STOMP` ëŠ” WebSocket ìœ„ì—ì„œ ë™ì‘í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ í”„ë¡œí† ì½œë¡œ pub-sub ëª¨ë¸ì„ ì§€ì›í•œë‹¤. `SockJS` ëŠ” WebSocketì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œë„ ì˜ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê¸°ìˆ ì´ë‹¤.

```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/chat")
public class ChatController {
    private final ChatService chatService;

    // ...

    @PostMapping("/write-websocket")
    @ResponseBody
    public ResponseEntity<ChatDto.WriteMessageResponse> writeMessageWebSocket(@RequestBody ChatDto.WriteMessageRequest writeMessageRequest) {
        Chat chat = chatService.writeMessageWebSocket(writeMessageRequest.getName(), writeMessageRequest.getContent());

        return ResponseEntity.ok(
                ChatDto.WriteMessageResponse.builder()
                        .chat(chat)
                        .build()
        );
    }

    @GetMapping("/messages")
    @ResponseBody
    public ResponseEntity<ChatDto.MessagesResponse> messages(Long fromId) {
        return ResponseEntity.ok(
                ChatDto.MessagesResponse.builder()
                        .chats(chatService.getMessages(fromId))
                        .totalCount(chatService.getTotalCount())
                        .build()
        );
    }

    // ...
}
```

```java
@Service
@RequiredArgsConstructor
public class ChatService {
    private final ChatRepository chatRepository;
    private final SseEmitters sseEmitters;
    private final SimpMessagingTemplate simpleMessagingTemplete;

    // ...

    @Transactional
    public Chat writeMessageWebSocket(String name, String content) {
        Chat chat = Chat.builder()
                .name(name)
                .content(content)
                .createDate(LocalDateTime.now())
                .build();

        simpleMessagingTemplete.convertAndSend("/topic/chat/writeMessage", chat);

        return chatRepository.save(chat);
    }

    // ...
}
```

`SimpMessagingTemplate` ëŠ” Springì—ì„œ ì œê³µí•˜ëŠ” ë©”ì„¸ì§• í…œí”Œë¦¿ì´ë‹¤. STOMP í”„ë¡œí† ì½œì„ í†µí•´ WebSocketì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•œë‹¤. ëª©ì ì§€ëŠ” `/topic/chat/writeMessage` ì´ë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ í•´ë‹¹ ê²½ë¡œë¥¼ êµ¬ë…í•˜ê³  ìˆë‹¤ë©´ ë°œí–‰ëœ ë©”ì„¸ì§€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.

### Client

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- ... -->
<script>
    // ...

    function Chat__writeMessage(form) {
        // ...

        // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
        fetchPost("/chat/write-websocket", {
            name: form.name.value,
            content: form.content.value,
        }).then(console.log); 

        form.content.value = "";
        form.content.focus();
    }

    // ...

    Chat__loadMore(); // ì´ˆê¸° ë©”ì„¸ì§€ ë¡œë“œ

    const socket = new SockJS("/ws");
    const StompClient = Stomp.over(socket);

    StompClient.connect({}, (frame) => {
        console.log("Connected: " + frame);
        StompClient.subscribe("/topic/chat/writeMessage", (data) => {
            console.log(data.body);
            Chat__loadMore();
        });
    });
</script>
```

ë¨¼ì € SockJS, STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

`SockJS()` ë¥¼ í†µí•´ /ws ì—”ë“œí¬ì¸íŠ¸ì— WebSocket ì—°ê²°ì„ ì‹œë„í•œë‹¤. `Stomp.over()` ë¡œ STOMP í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•œë‹¤. ì„œë²„ì— STOMP ì—°ê²°ì„ ìš”ì²­í•˜ê³ , ì—°ê²°ì´ ì„±ê³µë˜ì—ˆë‹¤ë©´ /topic/chat/writeMessage ê²½ë¡œë¥¼ êµ¬ë…í•œë‹¤.

### ë™ì‘ ê³¼ì •

![websocket.png](assets/img/prac_chat/5.png)

## ğŸ“Œ ê¹ƒí—ˆë¸Œ ë§í¬

https://github.com/whqtker/practice_chat