---
title : "[JPA] JPQL"
date : 2025-05-06 11:50:00 +0900
categories : [Spring Boot]
tags : [jpa, spring boot, jpql, μ¤ν”„λ§ λ¶€νΈ]
---

## π“ JPQLμ΄λ€?

`JPQL(Java Persistence Query Language)` λ” JPAμ—μ„ μ‚¬μ©ν•λ” κ°μ²΄ μ§€ν–¥ μΏΌλ¦¬ μ–Έμ–΄μ΄λ‹¤. SQLμ„ μ¶”μƒν™”ν• μΏΌλ¦¬ μ–Έμ–΄μ΄λ©°, SQLκ³Ό λΉ„μ·ν• λ¬Έλ²•μ„ κ°€μ§€μ§€λ§ SQLμ€ ν…μ΄λΈ”μ„ λ€μƒμΌλ΅ μΏΌλ¦¬λ¥Ό μ‘μ„±ν•λ” λ°λ©΄ JPQLμ€ μ—”ν‹°ν‹°λ¥Ό λ€μƒμΌλ΅ μΏΌλ¦¬λ¥Ό μ‘μ„±ν•λ‹¤.

JPAμ—μ„ μ κ³µν•λ” κΈ°λ³Έ λ©”μ„λ“λ΅ λ³µμ΅ν• μ΅°κ±΄μ„ κ°€μ§„ λ°μ΄ν„°λ¥Ό μ΅°νν•κΈ°μ—” ν•κ³„κ°€ μμΌλ©°, μ΄λ¥Ό κ·Ήλ³µν•κΈ° μ„ν•΄ JPQLμ΄ κ°λ°λμ—λ‹¤. JPQLμ€ μ΄ν›„ SQLλ΅ λ³€ν™λλ‹¤.

## π“ λ¬Έλ²•

```sql
SELECT m FROMMember m WHERE m.age > 18
```

- μ—”ν‹°ν‹°μ™€ μ†μ„±μ€ **λ€μ†λ¬Έμλ¥Ό κµ¬λ¶„**ν•λ‹¤. λ‹¨, SELECT, WHEREκ³Ό κ°™μ€ JPQL ν‚¤μ›λ“λ” λ€μ†λ¬Έμλ¥Ό κµ¬λ¶„ν•μ§€ μ•λ”λ‹¤.
- ν…μ΄λΈ” μ΄λ¦„μ΄ μ•„λ‹ **μ—”ν‹°ν‹° μ΄λ¦„μ„ μ‚¬μ©**ν•λ‹¤. μ—”ν‹°ν‹° μ΄λ¦„μ€ `@Entity` μ–΄λ…Έν…μ΄μ…μΌλ΅ μ„¤μ •ν•  μ μλ‹¤.
- **λ³„μΉ­μ„ ν•„μλ΅ μ‚¬μ©**ν•΄μ•Ό ν•λ©°, ASλ” μƒλµ κ°€λ¥ν•λ‹¤.

## π“ TypedQuery vs. Query

`TypedQuery` μ™€ `Query` λ” JPQLμ„ μ‚¬μ©ν•κΈ° μ„ν• μΏΌλ¦¬ νƒ€μ…μ΄λ‹¤. λ‘ νƒ€μ… λ¨λ‘ `EntityManager` μ `createQuery()` λ¥Ό νΈμ¶ν•μ—¬ μƒμ„±ν•λ‹¤.

### TypedQuery

TypedQueryλ” μΏΌλ¦¬ κ²°κ³Όμ λ¦¬ν„΄ νƒ€μ…μ΄ λ…ν™•ν•  λ• μ‚¬μ©ν•λ‹¤.  **λ‘ λ²μ§Έ μΈμλ΅ μ—”ν‹°ν‹° ν΄λμ¤λ¥Ό μ „λ‹¬**ν•λ‹¤.

```java
TypedQuery<Member> typedQuery = em.createQuery("select m from Member m where m.age > 18", Member.class);
List<Member> members = typedQuery.getResultList();
```

> `getResultList()`λ” κ²°κ³Όκ°€ ν•λ‚ μ΄μƒμΌ λ• μ‚¬μ©ν•λ©° κ²°κ³Όκ°€ λ¦¬μ¤νΈ νƒ€μ…μ΄λ‹¤.
`getSingleResult()` λ” κ²°κ³Όκ°€ ν•λ‚μΌ λ• μ‚¬μ©ν•λ©° λ‹¨μΌ κ°μ²΄λ¥Ό λ¦¬ν„΄ν•λ‹¤.
> 

TypedQueryλ¥Ό μ‚¬μ©ν•λ©΄ **λ¦¬ν„΄λλ” κ²°κ³Όλ¥Ό λ³„λ„μ μΊμ¤ν… μ—†μ΄ λ°”λ΅ μ‚¬μ©**ν•  μ μλ‹¤. λν• νƒ€μ… μ•μ „μ„±μ„ λ³΄μ¥ν•λ―€λ΅ **μ»΄νμΌ μ‹μ μ— νƒ€μ… μ¤λ¥λ¥Ό μ΅μ„ μ μλ‹¤.**

### Query

Queryλ” λ¦¬ν„΄ νƒ€μ…μ΄ λ…ν™•ν•μ§€ μ•κ±°λ‚ μ—¬λ¬ μ»¬λΌμ„ μ„ νƒν•μ—¬ μ΅°νν•  λ• μ‚¬μ©ν•λ‹¤.

```java
Query query = em.createQuery("select m.username, m.age from Member m where m.age > 18");
List<Object[]> resultList = query.getResultList();
```

Query νƒ€μ…μ κ²°κ³Όλ¥Ό μ‚¬μ©ν•  λ• μ μ ν• νƒ€μ…μΌλ΅ μΊμ¤ν…ν•μ—¬ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

## π“ νλΌλ―Έν„° λ°”μΈλ”©

νλΌλ―Έν„° λ°”μΈλ”©μ€ JPQLμ—μ„ μΏΌλ¦¬μ— νΉμ • κ°’μ„ λ™μ μΌλ΅ μ „λ‹¬ν•λ” λ°©λ²•μ΄λ‹¤. μ΄λ¥Ό ν†µν•΄ SQL Injectionμ„ λ°©μ§€ν•  μ μμΌλ©° μΏΌλ¦¬ μ¬μ‚¬μ©μ„±μ„ λ†’μΌ μ μλ‹¤.

### μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„°

νλΌλ―Έν„°λ¥Ό μ΄λ¦„μ„ κµ¬λ¶„ν•λ” λ°©μ‹μ΄λ‹¤. β€:β€™μ„ μ‚¬μ©ν•μ—¬ νλΌλ―Έν„° μ΄λ¦„μ„ μ§€μ •ν•λ‹¤.

```java
TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m WHERE m.username = :username", Member.class);
query.setParameter("username", "member1");
List<Member> resultList = query.getResultList();
```

### μ„μΉ κΈ°μ¤€ νλΌλ―Έν„°

β€?β€™ λ’¤μ— μ„μΉ κ°’μ„ μ§€μ •ν•λ” λ°©μ‹μ΄λ‹¤. μ„μΉ κ°’μ€ 1λ¶€ν„° μ‹μ‘ν•λ‹¤.

```java
TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m WHERE m.username = ?1", Member.class);
query.setParameter(1, "member1");
List<Member> resultList = query.getResultList();
```

μΌλ°μ μΌλ΅ μ„μΉ κΈ°μ¤€ νλΌλ―Έν„° λ°”μΈλ”©λ³΄λ‹¤ μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„° λ°”μΈλ”©μ΄ λ” κ¶μ¥λλ‹¤.

### λ©”μ„λ“ μ²΄μ΄λ‹

JPQL APIλ” λ©”μ„λ“ μ²΄μΈ ν•μ‹μΌλ΅ μ„¤κ³„λμ–΄ μλ‹¤.

```java
List<Member> members = em.createQuery("SELECT m FROM Member m WHERE m.username = :username", Member.class)
    .setParameter("username", "member1")
    .getResultList(); 
```

## π“ ν”„λ΅μ μ…

ν”„λ΅μ μ…(Projection)μ€ JPQLμ—μ„μ SELECTμ μ— μ΅°νν•  λ€μƒμ„ μ§€μ •ν•λ” κ²ƒμ„ μλ―Έν•λ‹¤.

### μ—”ν‹°ν‹° ν”„λ΅μ μ…

μ—”ν‹°ν‹° μμ²΄λ¥Ό μ΅°ν λ€μƒμ„ μ§€μ •ν•λ” λ°©μ‹μ΄λ‹¤.

```sql
SELECT m FROM Member m
SELECT m.team FROM Member m
```

μ—”ν‹°ν‹° ν”„λ΅μ μ…μΌλ΅ μ΅°νλ κ²°κ³Όλ” μμ†μ„± μ»¨ν…μ¤νΈμ—μ„ κ΄€λ¦¬λλ‹¤.

### μ„λ² λ””λ“ νƒ€μ… ν”„λ΅μ μ…

μ—”ν‹°ν‹°μ— ν¬ν•¨λ μ„λ² λ””λ“ νƒ€μ…μ„ μ΅°νν•λ” λ°©μ‹μ΄λ‹¤.

```sql
SELECT m.address FROM Member m

-- λ¶κ°€λ¥
SELECT a FROM Address a
```

μ„λ² λ””λ“ νƒ€μ…μ€ μ—”ν‹°ν‹°μ™€ μ μ‚¬ν•κ² μ‚¬μ©λμ§€λ§, μ΅°νμ μ‹μ‘μ μ΄ λ  μ μ—†λ‹¤.

### μ¤μΉΌλΌ νƒ€μ… ν”„λ΅μ μ…

μ«μλ‚ λ¬Έμ κ°™μ€ κΈ°λ³Έ λ°μ΄ν„° νƒ€μ…μ„ μ΅°νν•λ” λ°©μ‹μ΄λ‹¤.

```sql
SELECT m.username FROM Member m
```

μ—¬λ¬ μ¤μΉΌλΌ κ°’λ„ ν•¨κ» μ΅°νν•  μ μλ‹¤. `Object[]` νƒ€μ…μΌλ΅ μ΅°νν•λ” λ°©λ²•κ³Ό JPQLμ `new` ν‚¤μ›λ“μ™€ DTO ν΄λμ¤λ¥Ό ν†µν•΄ μ΅°νν•λ” λ°©λ²•μ΄ μλ‹¤.

```java
// Object[]
String jpql = "SELECT m.username, m.age FROM Member m";
List<Object[]> resultList = entityManager.createQuery(jpql).getResultList();

// DTO
String jpql = "SELECT new com.example.MemberDTO(m.username, m.age) FROM Member m";
List<MemberDTO> resultList = entityManager.createQuery(jpql, MemberDTO.class).getResultList();

```

DTO ν΄λμ¤λ¥Ό μ‚¬μ©ν•λ” λ°©λ²•μ΄ λ” κ¶μ¥λλ‹¤.

## π“ νμ΄μ§• API

JPQLμ—μ„ λ€μ©λ‰ λ°μ΄ν„°λ¥Ό ν¨μ¨μ μΌλ΅ μ΅°νν•κΈ° μ„ν•΄ νμ΄μ§•μ„ μ‚¬μ©ν•λ‹¤.

`setFirstResult(int startPos)` λ” μ΅°ν μ‹ μ‹μ‘ μ„μΉλ¥Ό μ§€μ •ν•λ” λ©”μ„λ“μ΄λ‹¤. `startPos + 1` λ²μ§Έ κ²°κ³Όλ¶€ν„° μ΅°νλ¥Ό μ‹μ‘ν•λ‹¤. μΈλ±μ¤λ” 0λ¶€ν„° μ‹μ‘ν•λ‹¤.

`setMaxResults(int maxResult)` λ” ν• λ²μ— μ΅°νν•  λ°μ΄ν„°μ μµλ€ κ°μλ¥Ό `maxResult` κ°λ΅ μ§€μ •ν•λ” λ©”μ„λ“μ΄λ‹¤.

```java
String jpql = "select m from Member m order by m.name desc";
List<Member> resultList = entityManager.createQuery(jpql, Member.class)
                              .setFirstResult(10)
                              .setMaxResults(20)
                              .getResultList();
```

μ„ μ½”λ“λ” 11λ² μ§Έ κ²°κ³Όλ¶€ν„° 20κ°μ λ°μ΄ν„°λ¥Ό μ΅°νν•λ” μ½”λ“μ΄λ‹¤.

JPQLμ νμ΄μ§• APIλ¥Ό μ‚¬μ©ν•λ©΄ SQLμ νμ΄μ§• μΏΌλ¦¬λ¥Ό μ§μ ‘ μ‘μ„±ν•  ν•„μ”κ°€ μ—†λ‹¤. μ—¬λ¬ DBMSλ§λ‹¤ λ‹¤λ¥Έ νμ΄μ§• μ²λ¦¬ μΏΌλ¦¬ λ¬Έλ²•μ΄ μ΅΄μ¬ν•κΈ°μ—, **κ°λ°μλ” DBMS μΆ…λ¥μ— κµ¬μ• λ°›μ§€ μ•κ³  μΌκ΄€λ λ°©μ‹μΌλ΅ νμ΄μ§• λ΅μ§μ„ κµ¬ν„ν•  μ μλ‹¤.**

## π“ μ§‘κ³„ ν•¨μ

JPQLμ€ SQLκ³Ό μ μ‚¬ν• μ§‘κ³„ ν•¨μλ¥Ό μ κ³µν•λ‹¤.

`COUNT(x)`: κ²°κ³Όμ κ°μ λ¦¬ν„΄, `Long`νƒ€μ…

`SUM(x)`: μ«μ ν•„λ“μ ν•©κ³„ κ³„μ‚°, `Long` , `Double` νƒ€μ…

`AVG(x)`: ν‰κ·  κ³„μ‚°, `Double` νƒ€μ…

`MAX(x)`: μµλ“κ°’ κ³„μ‚°

`MIN(x)`: μµμ†κ°’ κ³„μ‚°

```sql
SELECT COUNT(m), SUM(m.age), AVG(m.age), MAX(m.age), MIN(m.age)
FROM Member m
```

## π“ JOIN

### Inner Join

λ‘ μ—”ν‹°ν‹° κ°„ μ—°κ΄€κ΄€κ³„κ°€ μ΅΄μ¬ν•λ” λ°μ΄ν„°λ§ μ΅°νν•λ‹¤. `INNER` ν‚¤μ›λ“λ” μƒλµ κ°€λ¥ν•λ‹¤.

```sql
SELECT m FROM Member m INNER JOIN m.team t WHERE t.name = :teamName
```

### Outer Join

μ—°κ΄€κ΄€κ³„κ°€ μ—†λ”λΌλ„ κΈ°μ¤€μ΄ λλ” μ—”ν‹°ν‹°μ λ°μ΄ν„°λ¥Ό λ¨λ‘ ν¬ν•¨ν•μ—¬ μ΅°νν•λ‹¤. λ°μ΄ν„°κ°€ μ—†λ” κ²½μ° `NULL` λ΅ ν‘μ‹λλ‹¤. `OUTER` ν‚¤μ›λ“λ” μƒλµ κ°€λ¥ν•λ‹¤.

```sql
SELECT m FROM Member m LEFT OUTER JOIN m.team t
```

### Theta Join

μ—°κ΄€κ΄€κ³„ μ—†λ” μ—”ν‹°ν‹° κ°„μ—λ„ WHEREμ μ„ λ§μ΅±ν•λ” λ°μ΄ν„°λ¥Ό μ΅°μΈν•λ‹¤.

```sql
SELECT m FROM Member m, Team t WHERE m.username = t.name
```

---

JPA 2.1λ¶€ν„° `ON` μ μ„ μ‚¬μ©ν•μ—¬ μ΅°μΈ λ€μƒμ„ ν•„ν„°λ§ν•  μ μλ‹¤.

```sql
SELECT m FROM Member m LEFT JOIN m.team t ON t.name = 'A'
```

### Fetch Join

`Fetch Join` μ€ JPQLμ—μ„ μ„±λ¥ μµμ ν™”λ¥Ό μ„ν•΄ μ κ³µν•λ” κΈ°λ¥μ΄λ‹¤. **Fetch Joinμ„ ν†µν•΄ μ—°κ΄€λ μ—”ν‹°ν‹°λ‚ μ»¬λ ‰μ…μ„ ν”„λ΅μ‹ κ°μ²΄κ°€ μ•„λ‹ μ‹¤μ  λ°μ΄ν„°λ΅ SQL μΏΌλ¦¬μ™€ ν•¨κ» μ΅°νν•μ—¬ λ΅λ”©**ν•  μ μλ‹¤. μ΄λ¥Ό ν†µν•΄ N+1 λ¬Έμ λ¥Ό ν•΄κ²°ν•  μ μλ‹¤.

`JOIN FETCH` λΌλ” ν‚¤μ›λ“λ¥Ό μ‚¬μ©ν•λ©°, μ΅°ν μ£Όμ²΄κ°€ λλ” μ—”ν‹°ν‹°λΏλ§ μ•„λ‹λΌ FETCHλ΅ λ…μ‹λ μ—°κ΄€ μ—”ν‹°ν‹°κΉμ§€ ν•¨κ» μ΅°νν•μ—¬ μ¦‰μ‹ λ΅λ”©(Eager Loading) ν›„ μμ†ν™”ν•λ‹¤.

`@ManyToOne`, `@OneToOne` κ΄€κ³„μ—μ„ μ‚¬μ©ν•λ” νμΉ μ΅°μΈμ„ **μ—”ν‹°ν‹° νμΉ μ΅°μΈ**, `@OneToMany` κ΄€κ³„μ—μ„ μ‚¬μ©ν•λ” νμΉ μ΅°μΈμ„ **μ»¬λ ‰μ… νμΉ μ΅°μΈ**μ΄λΌκ³  ν•λ‹¤.

```sql
-- μ—”ν‹°ν‹° νμΉ μ΅°μΈ
SELECT m FROM Member m JOIN FETCH m.team

-- μ»¬λ ‰μ… νμΉ μ΅°μΈ
SELECT t FROM Team t JOIN FETCH t.members
```

**μ»¬λ ‰μ… νμΉ μ΅°μΈ μ‹ λ°μ΄ν„° μ¤‘λ³µμ΄ λ°μƒν•  μ μλ‹¤.** μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ `DISTINCT` ν‚¤μ›λ“λ¥Ό μ‚¬μ©ν•λ‹¤. μ• ν”λ¦¬μΌ€μ΄μ… λ λ²¨μ—μ„ μ—”ν‹°ν‹°μ μ‹λ³„μλ¥Ό κΈ°μ¤€μΌλ΅ μ¤‘λ³µλ μ—”ν‹°ν‹°λ¥Ό μ κ±°ν•λ‹¤.

νμΉ μ΅°μΈμ€ `FetchType` κ°™μ€ κΈ€λ΅λ² λ΅λ”© μ „λµλ³΄λ‹¤ μ°μ„ μμ„κ°€ λ†’λ‹¤. λ³΄ν†µ μ—”ν‹°ν‹° λ΅λ”© μ „λµμ„ `fetch = FetchType.LAZY` λ΅ μ„¤μ •ν•κ³  ν•„μ”ν• κ²½μ° νμΉ μ΅°μΈμ„ μ‚¬μ©ν•λ” κ²½μ°κ°€ λ§λ‹¤. λν• νμΉ μ΅°μΈ λ€μƒμ—λ” λ³„μΉ­μ„ μ‚¬μ©ν•  μ μ—†λ‹¤. λ‘ μ΄μƒμ μ»¬λ ‰μ…μ„ νμΉ μ΅°μΈν•  μ μ—†μΌλ©°, νμ΄μ§• APIλ¥Ό μ‚¬μ©ν•  μ μ—†λ‹¤.

μΌλ° μ΅°μΈκ³Ό νμΉ μ΅°μΈμ κ°€μ¥ ν° μ°¨μ΄μ μ€ μ—°κ΄€ μ—”ν‹°ν‹°μ μ΅°ν λ° μμ†ν™” μ—¬λ¶€μ΄λ‹¤. **μΌλ° μ΅°μΈμ€ μ—°κ΄€ μ—”ν‹°ν‹°λ¥Ό λ΅λ”©ν•μ§€ μ•μΌλ©° μμ†ν™”ν•μ§€ μ•λ”λ‹¤. κ·Έλ¬λ‚ νμΉ μ΅°μΈμ€ μ—°κ΄€ μ—”ν‹°ν‹°λ¥Ό ν•¨κ» λ΅λ”©ν•μ—¬ μμ†μ„± μ»¨ν…μ¤νΈμ— λ΅λ”©ν•λ‹¤.**

## π“ @Query

JPAμ—μ„ `@Query` μ–΄λ…Έν…μ΄μ…μ„ ν†µν•΄ μ§μ ‘ JPQL λλ” Native SQL μΏΌλ¦¬λ¥Ό μ‘μ„±ν•  μ μλ‹¤.

```sql
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("SELECT u FROM User u WHERE u.status = 1")
    Collection<User> findAllActiveUsers();
}
```

`nativeQuery = true` μ†μ„±μ„ ν†µν•΄ Native SQL μΏΌλ¦¬λ¥Ό μ‘μ„±ν•  μ μλ‹¤.

```sql
public interface UserRepository extends JpaRepository<User, Long> {
    @Query(
      value = "SELECT * FROM USERS u WHERE u.status = 1",
      nativeQuery = true)
    Collection<User> findAllActiveUsersNative();
}
```

λ©”μ„λ“μ νλΌλ―Έν„°μ— `@Param` μ–΄λ…Έν…μ΄μ…μ„ ν†µν•΄ JPQL λ‚΄μ νλΌλ―Έν„° μ΄λ¦„κ³Ό λ§¤ν•‘ν•  μ μλ‹¤.

```sql
public interface MemberRepository extends JpaRepository<Member, Long> {
    @Query("select m from Member m where m.username = :name")
    Member findMembers(@Param("name") String username);
}
```

INSERT, UPDATE, DELETEμ™€ κ°™μ€ DML μΏΌλ¦¬λ¥Ό μ‚¬μ©ν•  λ•, `@Modifying` μ–΄λ…Έν…μ΄μ…μ„ ν•¨κ» μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @Transactional
    @Modifying
    @Query("update User u set u.name = :name where u.id = :id")
    int updateName(@Param("id") Long id, @Param("name") String name); // λ²ν¬ μ—°μ‚°μ€ μ—…λ°μ΄νΈλ ν–‰ μλ¥Ό λ°ν™
}
```

## π“ μ°Έκ³ 

https://ittrue.tistory.com/270

https://adjh54.tistory.com/479

https://ict-nroo.tistory.com/116

https://velog.io/@kevin_/JPQL