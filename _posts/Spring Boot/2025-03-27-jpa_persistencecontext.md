---
title : "[JPA] JPAì˜ ê°œë…ê³¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸"
date : 2025-03-27 13:00:00 +0900
categories : [Spring Boot]
tags : [java, spring boot, jpa, persistence context, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸, ìŠ¤í”„ë§ ë¶€íŠ¸]
---

## ğŸ“Œ JPAë€?

`JPA(Java Persistence API)` ëŠ” ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ RDBMSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ **í‘œì¤€ ORM ê¸°ìˆ **ì´ë‹¤. JPAëŠ” **ì¸í„°í˜ì´ìŠ¤**ë¡œ, ì´ë¥¼ êµ¬í˜„í•œ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. JPAì˜ êµ¬í˜„ì²´ëŠ” **Hibernate, EclipseLink, OpenJPA, DataNucleus** ë“±ì´ ìˆë‹¤.

![image.png](assets/img/jpa/1.png)

ì „ì²´ì ì¸ ë°ì´í„° íë¦„ì€ ì•„ë˜ì™€ ê°™ë‹¤.

1. ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ JPAë¥¼ í˜¸ì¶œí•œë‹¤. 
2. JPAê°€ ê°ì²´ ì§€í–¥ì  ì½”ë“œë¥¼ SQL ì¿¼ë¦¬ë¡œ ë³€í™˜í•œ í›„ JDBCì— ì „ë‹¬í•œë‹¤. 
3. JDBC APIëŠ” ì ì ˆí•œ JDBC ë“œë¼ì´ë²„ë¥¼ í†µí•´ ì¿¼ë¦¬ë¥¼ DBì— ì „ì†¡í•œë‹¤. 
4. DBëŠ” ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ JDBC ë“œë¼ì´ë²„ì— ì „ë‹¬í•œë‹¤. 
5. ë“œë¼ì´ë²„ëŠ” ë‹¤ì‹œ ê²°ê³¼ë¥¼ JDBC APIë¡œ ì „ë‹¬í•˜ë©°, JPAëŠ” ë°›ì€ ê²°ê³¼ë¥¼ ìë°” ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ë‹¬í•œë‹¤.

## ğŸ“Œ ORM

![image.png](assets/img/jpa/2.png)

- **JPAëŠ” ORMì˜ ì¼ì¢…**ì´ë‹¤.
`ORM(Object-Relational Mapping)` ì€ ê°ì²´ ì§€í–¥ í”„ë¡œê·¸ë˜ë°ê³¼ RDBMS ê°„ ë°ì´í„° ë³€í™˜ ë° ë§¤í•‘í•˜ëŠ” ë„êµ¬ì´ë‹¤. ORMì„ í†µí•´ SQL ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì§€ ì•Šê³  **ê°ì²´ ì§€í–¥ì  ì½”ë“œë¥¼ í†µí•´ DB ì‘ì—…ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆë‹¤.

### ì¥ì 

- **ë©”ì„œë“œë¥¼ í˜¸ì¶œ**í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°œë°œ ì†ë„ë¥¼ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤. ë” ë‚˜ì•„ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤.
- **ê°ì²´ ì§€í–¥ì **ì¸ ì½”ë“œ ì‘ì„±ìœ¼ë¡œ ìƒì‚°ì„±ì´ ì¦ê°€í•˜ë©°, ì½”ë“œ ì¬í™œìš©ì´ ê°€ëŠ¥í•˜ë‹¤.
    - ë°ì´í„°ë² ì´ìŠ¤ê°€ êµì²´ë˜ì–´ë„ ì½”ë“œë¥¼ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ë‹¤. ì¦‰, DBMSì— ëŒ€í•´ ì½”ë“œê°€ ì¢…ì†ì ì´ì§€ ì•Šë‹¤.

### ë‹¨ì 

- ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ í‘œí˜„í•˜ëŠ” ë° ì í•©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.
- OOPì™€ RDBMSì˜ ì´í•´ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì†Œ ë†’ì€ ëŸ¬ë‹ ì»¤ë¸Œë¥¼ ê°€ì§„ë‹¤.

## ğŸ“Œ JPA vs. MyBatis

JPAì™€ MyBatis ëª¨ë‘ ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ DB ê°„ ìƒí˜¸ì‘ìš©ì—ì„œ ì‚¬ìš©ë˜ëŠ” í”„ë ˆì„ì›Œí¬ì´ë‚˜, ê°€ì¥ í° ì°¨ì´ì ì€ **JPAëŠ” ORM, MyBatisëŠ” SQL Mapper**ë¼ëŠ” ê²ƒì´ë‹¤.

`SQL Mapper`ëŠ” DBì˜ SQL ì¿¼ë¦¬ì™€ ê·¸ ê²°ê³¼ë¥¼ ê°ì²´ë¡œ ë§¤í•‘í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ë¹„êµì  ì‚¬ìš©ì´ í¸ë¦¬í•˜ë‚˜, DBMSì— ë”°ë¼ SQL ë¬¸ë²•ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°, SQLì„ ì§ì ‘ ì‘ì„±í•´ì•¼ í•œë‹¤ëŠ” ë‹¨ì ì´ ì¡´ì¬í•œë‹¤.

## ğŸ“Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸

`Persistence Context`(ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸)ëŠ” ì—”í‹°í‹°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•˜ëŠ” í™˜ê²½ì„ ë§í•œë‹¤. ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ DB ì‚¬ì´ì— `Entity`ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ê°€ìƒì˜ DBë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. ì´ëŸ¬í•œ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” ì£¼ì²´ê°€ `EntityManager`ì´ë‹¤.

### Entity

DBì˜ í…Œì´ë¸”ì„ í´ë˜ìŠ¤ë¡œ êµ¬í˜„í•œ ê²ƒì´ë‹¤.

### EntityManager

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì—¬ ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•œë‹¤.

EntityManagerë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ê°€ ì¡´ì¬í•œë‹¤.

1\. Container-Managed

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ `EntityManagerFactory` ì—ì„œ `EntityManager`ë¥¼ ìƒì„±í•˜ì—¬ ì£¼ì…í•˜ëŠ” ë°©ì‹ì´ë‹¤. Thread-safeí•œ ë°©ë²•ì´ë‹¤.

> Thread-safe ë¼ëŠ” ê²ƒì€ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ìì›ì´ë‚˜ ê°ì²´ì— ì ‘ê·¼í•´ë„ ìˆ˜í–‰í•˜ëŠ” ë™ì‘ì´ ë³´ì¥ëœë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.
>


```java
@PersistenceContext
EntityManager entityManager;
```

`@PersistenceContext` ë¡œ ì£¼ì…ë°›ëŠ” `EntityManager` ëŠ” í”„ë¡ì‹œë¡œ ê°ì‹¸ì ¸ ìˆë‹¤. ë”°ë¼ì„œ í”„ë¡ì‹œê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ í˜„ì¬ ì“°ë ˆë“œì— ë°”ì¸ë”©ëœ ì‹¤ì œ `EntityManager` ë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ì¡°íšŒí•˜ì—¬ ìœ„ì„í•œë‹¤. ë”°ë¼ì„œ ë‹¨ì¼ í”„ë¡ì‹œ ê°ì²´ê°€ ì—¬ëŸ¬ ì“°ë ˆë“œì— ê³µìœ ë˜ë”ë¼ë„ ê° ì“°ë ˆë“œëŠ” ìì‹ ë§Œì˜ `EntityManager` ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

2\. Application-Managed

`EntityManagerFactory`ì—ì„œ ì§ì ‘ EntityManagerë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤.

```java
@Autowired
private EntityManagerFactory emf;

public void someMethod() {
    EntityManager em = emf.createEntityManager();
    // ...
    em.close();
}
```

ë‹¤ë§Œ, ê°œë°œìê°€ ì§ì ‘ `EntityManager` ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ë“œë¬¼ë‹¤. `JpaRepository` ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ `EntityManager` ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

### Entity Lifecycle

![image.png](assets/img/jpa/3.png)

ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ì˜ ê´€ê³„ì— ë”°ë¼ í¬ê²Œ ë„¤ ê°€ì§€ ìƒíƒœë¥¼ ê°€ì§„ë‹¤.

1\. ë¹„ì˜ì†(New/Transient)

ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒíƒœì´ë‹¤.

```java
Member member = new Member();
member.setId("member1");
```

2\. ì˜ì†(Managed)

ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì´ë‹¤.

```java
em.persist(member);
```

3\. ì¤€ì˜ì†(Detached)

ì—”í‹°í‹°ê°€ í•œë•Œ ì˜ì† ìƒíƒœì˜€ë‹¤ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœì´ë‹¤.

```java
em.detach(member);
em.clear();
em.close();
```

`detach()` ë¥¼ í†µí•´ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬í•œë‹¤.

`clear()` ë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•œë‹¤.

`close()` ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê´€ë¦¬í•˜ëŠ” EntityManagerë¥¼ ë‹«ëŠ”ë‹¤.

`merge()` ë¥¼ í†µí•´ ë¶„ë¦¬ëœ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë³‘í•©í•  ìˆ˜ ìˆë‹¤.

4\. ì‚­ì œ(Removed)

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ì—”í‹°í‹°ê°€ ì‚­ì œëœ ìƒíƒœì´ë‹¤.

```java
em.remove(member);
```

`remove()` ë¥¼ í†µí•´ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ DB ëª¨ë‘ ì œê±°í•œë‹¤.

ë” ë”ì•™í•œ `EntityManager` ê´€ë ¨ ë©”ì„œë“œëŠ” [ì—¬ê¸°](https://whqtker.github.io/posts/persistence_context_method/)ë¥¼ ì°¸ê³ í•œë‹¤.

### ì¥ì 

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ë‚´ë¶€ì— **1ì°¨ ìºì‹œ**ë¥¼ ê°€ì§€ê³  ìˆë‹¤. ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ ë™ì¼í•œ ì—”í‹°í‹° ì ‘ê·¼ ì‹œ DBê°€ ì•„ë‹Œ ìºì‹œì—ì„œ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤. ë‹¨, **1ì°¨ ìºì‹œëŠ” íŠ¸ëœì­ì…˜ ë‹¨ìœ„**ì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ì´ ëë‚˜ë©´ ìºì‹œì˜ í•´ë‹¹ ì •ë³´ëŠ” ì‚¬ë¼ì§€ê²Œ ëœë‹¤.
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ê°€ ê³µìœ í•˜ëŠ” ìºì‹œëŠ” 2ì°¨ ìºì‹œë¼ê³  ë¶€ë¥¸ë‹¤.
- ê°™ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ê°™ì€ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ë©´ ë™ì¼í•œ ê°ì²´ ì°¸ì¡°ë¥¼ ë¦¬í„´í•œë‹¤. ì´ë¥¼ í†µí•´ **ë™ì¼ì„±**ì„ ë³´ì¥í•œë‹¤.

```java
Member a = em.find(Member.class, "member1"); // DB ì¡°íšŒ
Member b = em.find(Member.class, "member1"); // 1ì°¨ ìºì‹œ ì¡°íšŒ
System.out.println(a == b); // true (ë™ì¼ì„± ë³´ì¥)
```

- SQL ì¿¼ë¦¬ë¥¼ ë°”ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ì´ë“¤ì„ ëª¨ì•„ í•œ ë²ˆì— ì‹¤í–‰**í•œë‹¤. ì´ë¥¼ í†µí•´ DB ì ‘ê·¼ íšŸìˆ˜ë¥¼ ì¤„ì—¬ ì„±ëŠ¥ì„ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.
- ì—”í‹°í‹°ì˜ ë³€ê²½ ì‚¬í•­ì„ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ UPDATE ì¿¼ë¦¬ë¬¸ì„ ìƒì„±í•œë‹¤. ì´ë¥¼ `Dirty Checking`ì´ë¼ê³  í•œë‹¤.
- `Lazy Loading`(ì§€ì—° ë¡œë”©) ê¸°ëŠ¥ì„ í†µí•´ í•„ìš”í•œ ì‹œì ì— ê´€ë ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë‹¤.

## ğŸ“Œ JPA ë©”ì„œë“œ

JPAëŠ” ë©”ì„œë“œ ì´ë¦„ì—ì„œ ìë™ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

`findBy` ëŠ” íŠ¹ì • ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œë‹¤.

`existBy` ëŠ” íŠ¹ì • ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì—”í‹°í‹° ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.

`deleteBy` ëŠ” íŠ¹ì • ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì—”í‹°í‹°ë¥¼ ì‚­ì œí•œë‹¤.

`countBy` ëŠ” íŠ¹ì • ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì—”í‹°í‹° ìˆ˜ë¥¼ ê³„ì‚°í•œë‹¤.

```java
List<Book> findByTitle(String title);
List<Book> findByTitleOrAuthor(String title, String author);
```

ë” ìì„¸í•œ ë©”ì„œë“œëŠ” [ì—¬ê¸°](https://whqtker.github.io/posts/jpa.method/)ë¥¼ ì°¸ê³ í•œë‹¤.

---

`@Query` ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ JPQL ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```java
@Query("select u from User u where u.firstname = ?1 and u.emailAddress = ?#{principal.emailAddress}")
List<User> findByFirstnameAndCurrentUserWithCustomQuery(String firstname);
```

## ğŸ“Œ í˜ì´ì§•

ì„¸ ê°€ì§€ ê°œë…ì´ ì¡´ì¬í•œë‹¤.

`Pageable`: í˜ì´ì§• ì •ë³´ë¥¼ ë‹´ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ í˜ì´ì§€ ë²ˆí˜¸, í¬ê¸°, ì •ë ¬ ë°©ì‹ ë“±ì„ í¬í•¨í•œë‹¤.

`PageRequest`: Pageable ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¡œ `PageRequest.of()`ë¥¼ í†µí•´ ìƒì„±í•œë‹¤.

`Page`: í˜ì´ì§• ê²°ê³¼ë¥¼ ë‹´ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ì¡°íšŒëœ ë°ì´í„°ì™€ í˜ì´ì§• ê´€ë ¨ ë©”íƒ€ë°ì´í„°ë¥¼ ì œê³µí•œë‹¤.

### êµ¬í˜„ ë°©ë²•

ì•„ë˜ëŠ” Repository ì½”ë“œì´ë‹¤.

```java
public interface PersonRepository extends JpaRepository<Person, Long> {
    Page<Person> findByName(String name, Pageable pageable);
}
```

ë©”ì„œë“œì— Pageable íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ë©´ JPAê°€ ìë™ìœ¼ë¡œ í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰í•œë‹¤.

ì•„ë˜ëŠ” Controller ì½”ë“œì´ë‹¤.

```java
@GetMapping
public Page<AccountDto.Res> getAccounts(Pageable pageable) {
    return accountService.findAll(pageable).map(AccountDto.Res::new);
}
```

ë©”ì„œë“œ íŒŒë¼ë¯¸í„°ë¡œ Pageable íƒ€ì…ì„ ì„ ì–¸í•˜ë©´ URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë˜ëŠ” í˜ì´ì§• ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë°”ì¸ë”©í•˜ì—¬ Pageable ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.

ì•„ë˜ëŠ” Service ì½”ë“œì´ë‹¤.

```java
public Page<Product> findProductsByName(String name, Pageable pageable) {
    return productRepository.findByName(name, pageable);
}
```

ì»¨íŠ¸ë¡¤ëŸ¬ë¶€í„° ì „ë‹¬ë°›ì€ Pageable ê°ì²´ë¥¼ ë ˆíŒŒì§€í† ë¦¬ë¡œ ì „ë‹¬í•œë‹¤.

## ğŸ“Œ ì°¸ê³ 

[https://velog.io/@modsiw/JPAJava-Persistence-APIì˜-ê°œë…](https://velog.io/@modsiw/JPAJava-Persistence-API%EC%9D%98-%EA%B0%9C%EB%85%90)

[https://ittrue.tistory.com/254](https://ittrue.tistory.com/254)

[https://velog.io/@neptunes032/JPA-ì˜ì†ì„±-ì»¨í…ìŠ¤íŠ¸ë€](https://velog.io/@neptunes032/JPA-%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%EB%9E%80)